<html>
<head>
  <title>Write captions for pictures</title>
  <!-- easyturk depends on these libraries -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js'></script>
  <!-- end of required libraries -->
  <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js'></script>
  <style>
    #counter {
      margin: 0 10px;
      font-size: 20pt;
      font-weight: bold;
    }
    img {
      height: 600px;
    }
    img.example {
      height: 200px;
    }
    .tasks-container {
      margin-top: 15px;
      margin-bottom: 30px;
      background-color: #DBDBDB;
    }
    .examples-container {
      margin-top: 15px;
      margin-bottom: 30px;
      background-color: #9fbccb;
    }
    .instructions-container {
      margin-top: 15px;
      margin-bottom: 30px;
      background-color: #F0EAD6;
    }
    p {
      font-size: 17px;
      text-align: center;
    }
    li {
        font-size: 22px;
    }
    div {
        font-size: 22px;
    }
  </style>
</head>
<body>

<div class='container tasks-container'>
  <div class='container'>
    <h2 id="task-instruction">TASK instruction</h2>
  </div>

  <div class='container-fluid'>
    <div class='row'>
      <div class='col-12'>
        <div id='image-container'></div>
      </div>
    </div>

    <br/>

    
    <span id="modified">Please select one caption that faithfully describes the image</span>:</span>
    <div class='row justify-content-left'>
      <div class='col-6 questions'></div>
    </div>
    <div class='row justify-content-center' style='margin-top: 10px; padding-bottom: 10px;'>
      <div class='col-1'>
        <button id='prev-btn' class='btn btn-lg btn-primary' disabled>Back</button>
      </div>
      <div class='col-2' style="text-align: center">
        <span id='counter'>
          <span class='counter-top'></span> / <span class='counter-bottom'></span>
        </span>
      </div>
      <div class='col-1'>
        <button id='next-btn' class='btn btn-lg btn-primary' disabled>Next</button>
      </div>
    </div>
  </div>
</div>

<!--IMPORTANT: This import contains all the functions you need to read in your input data and send back worker outputs.-->  
{% include "easyturk.html" %}

  <script>
    // Define some default input.
    // It is good practice to define standard inputs for a task which will be overwritten when launching
    // your actual task. The default inputs allow you to render and debug your task locally.
    var DEFAULT_INPUT = [{
        "id": 1,
        "task instruction": "task instruction",
        "image": "https://cs.stanford.edu/people/rak248/VG_100K/1160052.jpg",
        "captions": ["caption A", "caption B", "caption C", "caption D", "caption E"]
    }]

    var input = null;

    // This is where we will be collecting the answers for each image;
    var answers = [];

    // Some variables to track state of the HIT.
    var idx = 0;
    var enabled = false;

    function main() {
      // If this is a HIT on AMT, then replace the default input with the real input.
      input = easyturk.getInput(DEFAULT_INPUT);

      // Enable the task.
      if (!easyturk.isPreview()){
        enableTask();
      }

      // Set up the correct.
      _.each(input, function() { answers.push(null); });

      // Preload all images
      _.each(input, function(input_elem) {
        var imgUrl = input_elem['image'];
        var img = new Image();
        img.onload = function() { console.log('loaded image from ' + imgUrl); };
        img.src = imgUrl;
      });

      render();
    }

    // Use the current index to update the image and description
    function render() {
      // Set up the image
      $('#task-instruction').text(input[idx]['task instruction'])
      $('#image-container').empty();
      $("<img style='width:60%; height:auto; display:block; margin: 0 auto 0 auto'>").attr('src', input[idx]['image']).appendTo($('#image-container'));
      // $("<span style='display:inline'> Image caption: </span><span>" + input[idx]['caption'] + "</span><br>").appendTo($('#image-container'));
      // $("<span style='display:inline'> Modifications: </span><span>" + input[idx]['modification'] + "</span><br>").appendTo($('#image-container'));
      // $("<span><strong>Machie-generated negative caption: </strong></span><span>" + input[idx]['new_caption'] + "</span><br>").appendTo($('#image-container'));

      // $('#modified').html(input[idx]['modified']);
      // Set up the input question list
      // $('.questions').html(`
      //   <h3 display="inline">${input[idx]['question 1']}</h4> <input type="radio" id="q1_ans_t" name="q1" value="1"> <label for="q1_ans_t">Yes</label> <input type="radio" id="q1_ans_f" name="q1" value="0"> <label for="q1_ans_f">No</label>
      //   <h3 display="inline">${input[idx]['question 2']}</h4> <input type="radio" id="q2_ans_t" name="q2" value="1"> <label for="q2_ans_t">Yes</label> <input type="radio" id="q2_ans_f" name="q2" value="0"> <label for="q2_ans_f">No</label>
      //   <h3 display="inline">${input[idx]['question 3']}</h4> <input type="radio" id="q3_ans_t" name="q3" value="1"> <label for="q3_ans_t">Yes</label> <input type="radio" id="q3_ans_f" name="q3" value="0"> <label for="q3_ans_f">No</label>
      // `);
      input[idx]['captions'].forEach((e, i) => {
        $(`<input type="radio" name="captions" value="${i}"><h5 style="display:inline;margin-left:10px">${e}</h5><br>`
        ).appendTo($('.questions'));
      })

      // Refresh the counter
      $('.counter-top').text(idx + 1);
      $('.counter-bottom').text(input.length);

      // If the UI is enabled, enable or disable the buttons depending on
      // the index.
      if (enabled) {
        $('#prev-btn').prop('disabled', false);
        $('#next-btn').prop('disabled', false);
        if (idx == 0) {
          $('#prev-btn').prop('disabled', true);
        }
        if (idx == input.length - 1) {
          $('#next-btn').prop('disabled', true);
        }
      }
    }

    // Update the index, and save the text in the text area.
    function setIdx(newIdx) {
      if (newIdx < 0 || newIdx >= input.length) return;
      idx = newIdx;
      render();
    }

    function saveCaption() {
      let caption_ans = $('input:radio[name="captions"]:checked').val();
      // let q2_ans = $('input:radio[name="q2"]:checked').val();
      // let q3_ans = $('input:radio[name="q3"]:checked').val();
      res = caption_ans
      if (res === undefined) {
        alert("Please answer all questions before moving on.");
        return false;
      }
      answers[idx] = res;
      return true;
    }

    // Enable the UI.
    function enableTask() {
      enabled = true;
      easyturk.setupSubmit();

      // Enable components
      $('#next-btn').click(function() {
          if (saveCaption()) {
              setIdx(idx + 1);
              if (answers[idx] !== undefined) {
                $('input:radio[name="captions"][value="' + answers[idx] + '"]').prop('checked', true);
                // $('input:radio[name="q2"][value="' + answers[idx][1] + '"]').prop('checked', true);
                // $('input:radio[name="q3"][value="' + answers[idx][2] + '"]').prop('checked', true);
              }
          }
      });
      $('#prev-btn').click(function() {
          if (saveCaption()) {
              setIdx(idx - 1);
              if (answers[idx] !== undefined) {
                $('input:radio[name="captions"][value="' + answers[idx] + '"]').prop('checked', true);
                // $('input:radio[name="q2"][value="' + answers[idx][1] + '"]').prop('checked', true);
                // $('input:radio[name="q3"][value="' + answers[idx][2] + '"]').prop('checked', true);
              }
          }
      });
      $('#submit-btn').prop('disabled', false);

      $('#submit-btn').click(function() {
        // Make sure to save the last one.
        if (!saveCaption()) {
          return false;
        }

        // Copy the url and captions to the output we will return to the requester.
        var output = input;
        for (var i = 0; i < output.length; i++) {
          output[i]['answers'] = answers[i];
        }
        if (easyturk.isPreview()) {
          alert("This is only a preview. Here is your output: \n" + JSON.stringify(output));
          return false;
        } else {
          easyturk.setOutput(output);
          return true;
        }
      });
    }

    main();
  </script>
</body>
</html>
